<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" href="/favicon.ico" sizes="48x48"/>
    <meta name="viewport" content="viewport-fit=cover,width=device-width, initial-scale=1, user-scalable=no, shrink-to-fit=no" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Penelo" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/iphone5_splash.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/iphone6_splash.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/iphoneplus_splash.png" media="(device-width: 621px) and (device-height: 1104px) and (-webkit-device-pixel-ratio: 3)" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/iphonex_splash.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/iphonexr_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2)" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/iphonexsmax_splash.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3)" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/ipad_splash.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2)" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/ipadpro1_splash.png" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2)" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/ipadpro3_splash.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2)" />
    <link rel="apple-touch-startup-image" href="/iOS/splashscreens/ipadpro2_splash.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2)" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.1/css/all.min.css" />

    <meta
      name="simplewebrtc-config-url"
      content="https://api.simplewebrtc.com/config/guest/152fc7a1fc48368c4c948f9e"
    />

    <!--
      The app can be configured to play sounds in some cases:

      <meta name="simplewebrtc-sound-message-receive" content="/url-of-mp3-file" />
      <meta name="simplewebrtc-sound-message-send" content="/url-of-mp3-file" />
      <meta name="simplewebrtc-sound-peer-enter" content="/url-of-mp3-file" />
      <meta name="simplewebrtc-sound-peer-exit" content="/url-of-mp3-file" />
      <meta name="simplewebrtc-sound-test-output" content="/url-of-mp3-file" />
    -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script type="module" src="https://cdn.jsdelivr.net/npm/@pwabuilder/pwainstall"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@pwabuilder/pwaupdate"></script>
    <title>Penelo</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        height: 100%;
        font-family: -apple-system,
          BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell',
          'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        font-size: 16px;
        line-height: 1.5;
        color: #3f3f3f;
        text-rendering: optimizeSpeed;
        background-color: transparent!important;
      }

      code {
        font-family: source-code-pro, Menlo, Monaco, Consolas, 'Courier New',
          monospace;
      }

      [hidden] {
        display: none;
      }

      a {
        background-color: transparent;
        text-decoration: none;
      }

      a:active,
      a:hover {
        outline: 0;
      }

      img {
        border: 0;
      }

      svg:not(:root) {
        overflow: hidden;
      }

      button,
      input {
        color: inherit;
        font: inherit;
        margin: 0;
      }

      select {
        border-radius: 50px;
      }

      button {
        overflow: visible;
      }

      button {
        text-transform: none;
      }

      button,
      html input[type='button'],
      input[type='reset'],
      input[type='submit'] {
        -webkit-appearance: button;
        cursor: pointer;
      }

      button[disabled],
      html input[disabled] {
        cursor: default;
      }

      button::-moz-focus-inner,
      input::-moz-focus-inner {
        border: 0;
        padding: 0;
      }

      input {
        line-height: normal;
      }

      *,
      *:after,
      *:before {
        box-sizing: border-box;
      }

      img,
      video {
        max-width: 100%;
      }

      html {
        box-sizing: border-box;
      }

      *,
      *:before,
      *:after {
        box-sizing: inherit;
      }

      * {
        margin: 0;
        padding: 0;
      }
    
      .create-room-form {
        text-align: right;
        float: right;
        width: 75%;
        margin-right: 10px;
      }

      .create-room-form-input-wrapper {
        border: 1px #3f3f3f solid;
        padding: 10px;
        border-radius: 50px;
      }

      .create-room-form-input-wrapper:focus {
        border: 1px #3f3f3f solid;
      }

      .create-room-form-input {
        border: none;
        background: none;
        color: #007bff;
        width: 50%;
      }

      .create-room-form-input:focus,
      .create-room-form-button:focus {
        outline: none;
      }

      .create-room-form-button {
        margin-left: 10px;
        padding: 8px 10px !important;
        display: inline-block;
        border: 1px solid transparent;
        border-radius: 5px;
        background-color: #007bff;
        color: #ffffff;
      }

      .create-room-form-button:hover {
        background-color: #007bff;
      }

      .pwa {
        position: fixed;
        bottom: 20px;
        right: 25px;
        text-align: center;
      }

      pwa-install::part(openButton) {
        background-color: #007bff;
        border-radius: 5px;
        text-align: center;
        padding: 8px 10px;
        font-size: 16px;
      }

      pwa-install::part(installModal) {
        background-color: #007bff;
      }

      pwa-install::part(installButton) {
        background-color: #F25C54!important;
      }

      .homepage-header {
        margin: 0 auto; 
        padding-top: 20px; 
        padding-bottom: 5px;
        text-align: center;
        position: fixed;
        top: 0;
        width: 100%;
        backdrop-filter: blur(3px);
        -webkit-backdrop-filter: blur(3px);
      }

      .homepage-header > img {
        width: 40px;
        height: auto;
        border-radius: 50%;
        float: left;
        margin-left: 10px;
      }

      .homepage-header > span {
        float: left;
        color: #000000;
        font-size: 2em;
        line-height: 30px;
        margin-left: 10px;
        font-weight: normal;
      }

      .feed-block {
        height: auto;
        width: 100%;
        margin-top: 10px;
        margin-bottom: 20px;
        padding-bottom: 60px;
        text-align: left;
        border-bottom: 1px solid #eeeeee;
      }

      .feed-block > span {
        display: block;
        width: 100%;
        text-align: right;
        font-size: 12px;
        color: #bdbdbd;
      }

      .feed-block > p {
        display: block;
        font-weight: normal;
      }

      .feed-block > img {
        float: left;
        border-radius: 50%;
        margin-right: 10px;
        height: 56px;
        width: 56px;
        object-fit: cover;
        background-color: #ffffff;
      }

      .container {
        margin: 0 auto;
        width: 85%;
        max-width: 800px;
        text-align: center;
      }

      .reactions {
        display: block;
        width: 100%;
        text-align: right;
        margin-left: 10px!important;
        margin-top: 10px;
      }

      .reactions > span {
        color: #F25C54;
        cursor: pointer;
      }

      .feed-reaction-count {
        cursor: text;
        margin: 0 15px 0 5px;
      }

      @media (max-width: 849px)  {
        .feed-block {
          border-bottom: 1px solid #eeeeee;
        }
      }

      @media (min-width: 510px) and (max-width: 611px)  {
        .container {
          width: 100%;
        }

        .create-room-form {
          width: 70%;
        }

        .feed-block {
          min-height: 100px;
          height: auto;
          width: 100%;
          margin-top: 10px;
          padding: 0 20px 40px 20px;
          text-align: left;
          border-bottom: 1px solid #eeeeee;
        }
      }

      @media (min-width: 421px) and (max-width: 509px)  {
        .container {
          width: 100%;
        }

        .create-room-form {
          width: 65%;
        }

        .feed-block {
          height: auto;
          width: 100%;
          margin-top: 10px;
          padding: 0 20px 40px 20px;
          text-align: left;
          border-bottom: 1px solid #eeeeee;
        }

        .homepage-header {
          padding-top: 36px;
          background-color: #ffffff;
          border-bottom: 1px solid #eeeeee;
        }

        .homepage-header > span {
          color: #000000;
        }
      }

      @media (max-width: 420px) {
        .container {
          width: 100%;
        }
        
        .homepage-header {
          padding-top: 42px;
          background-color: #ffffff;
          border-bottom: 1px solid #eeeeee;
        }

        .homepage-header > img {
          width: 30px;
          height: auto;
          border-radius: 50%;
          float: left;
          margin-left: 10px;
          margin-top: 5px;
        }

        .homepage-header > span {
          float: left;
          color: #000000;
          font-size: 20px;
          line-height: 25px;
          margin-left: 10px;
          font-weight: normal;
          padding-top: 5px;
        }

        .pwa {
          position: fixed;
          bottom: 20px;
          right: 20px;
          text-align: center;
        }

        .haircheck-header-greeting {
          text-align: center;
          margin-top: 20px;
          color: #1a936f;
        }

        .create-room-form {
          text-align: right;
          float: right;
          width: 60%;
          margin-right: 10px;
        }

        .create-room-form-input-wrapper {
          width: 80%;
          display: inline-block;
          text-align: left;
          padding: 5px 10px;
        }

        .create-room-form-button {
          display: inline-block;
          margin-left: 0px;
          padding: 4px 6px!important;
        }

        .create-room-form-input {
          width: 100%;
        }

        .feed-block {
          height: auto;
          width: 100%;
          margin-top: 20px;
          padding: 0 15px 60px 15px;
          text-align: left;
          border-bottom: 1px solid #eeeeee;
        }

        .feed-block > img {
          width: 48px;
          height: 48px;
          float: left;
          border-radius: 50%;
          margin-right: 10px;
        }

        .feed-block > span {
          display: block;
          width: 100%;
          text-align: right;
          margin: 10px;
        }
      }
    </style>
  </head>
  <body onload="getReady()">
    <div id="root"></div>
    <template id="haircheck-header">
    </template>
    <template id="empty-peer-grid">
      <h2 style="text-align: center; color: #007bff">
        It's just you (for now!)
      </h2>
    </template>
    <template id="empty-roster">
      <div></div>
    </template>
    <template id="homepage">
      <div class="homepage-header">
        <img src="/apple-touch-icon.png" alt="Penelo logo"/>
        <span>penelo</span>
        <form class="create-room-form" method="GET" action="/">
          <span class="create-room-form-input-wrapper">
            <input
              type="text"
              name="room"
              placeholder="Enter a room name"
              class="create-room-form-input"/>
          </span>
          <button
            class="create-room-form-button button button-default button-undefined"
            type="submit">
            Go!
          </button>
        </form>
      </div>
      <div class="container" style="padding: 100px 0 50px 0;">
        <div class="feed container">
        </div>
        <div class="pwa">
          <script async defer>
            let installComponent = document.createElement("pwa-install");
            document.querySelector('.pwa').appendChild(installComponent);
            //installComponent.getInstalledStatus();
          </script>
          <script async defer>
            let updateComponent = document.createElement('pwa-update');
            document.querySelector('.pwa').appendChild(updateComponent);
          </script>
        </div>
      </div>
    </template>
    <script type="text/javascript">
      const params = new URLSearchParams(window.location.search);
      SimpleWebRTC.run({
        roomName: params.get('room'),
        root: document.getElementById('root'),
        gridPlaceholder: () => SimpleWebRTC.loadTemplate('empty-peer-grid'),
        haircheckHeaderPlaceholder: () =>
          SimpleWebRTC.loadTemplate('haircheck-header'),
        emptyRosterPlaceholder: () => SimpleWebRTC.loadTemplate('empty-roster'),
        homepagePlaceholder: () => SimpleWebRTC.loadTemplate('homepage')
      });

      function getReady() {
        getToken();
      }

      function getPenelo(token) {
        fetch('https://cactuar.moogleapi.com/v1/account/penelo', {
          method: 'get',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        }).then(response => response.json())
          .then(function(response) {
            getAnnouncements(token);
            if (response.rooms && response.rooms.length > 0) {
              let rooms = response.rooms;
              for (i = 0; i < rooms.length; i++) {
                // TODO: Rethink this
                // let img = document.createElement('img');
                // let p = document.createElement('p');
                // let span = document.createElement('span');
                // let div = document.createElement('div');
                // img.src = "/logo64.png";
                // p.innerHTML = 'Someone created the room <a href="?room=' + rooms[i].name + '">'+ rooms[i].name +'</a>. Go check it out. It might have a password, though.';
                // let timestamp = new Date(rooms[i].created_at);
                // span.innerHTML = timestamp.toLocaleString();
                // div.classList.add('feed-block');
                // div.appendChild(img);
                // div.appendChild(p);
                // div.appendChild(span);
                // document.querySelector('.feed').appendChild(div);
              } 
            } else {
                let img = document.createElement('img');
                let p = document.createElement('p');
                let span = document.createElement('span');
                let div = document.createElement('div');
                img.src = "https://mooglestorage.blob.core.windows.net/penelo/7acc71fe-5ba9-4610-ccad-08d84ec45cc9.jpg";
                p.innerHTML = "Seems there aren't any rooms active at the moment. You should go create one!";
                let timestamp = new Date();
                span.innerHTML = timestamp.toLocaleString();
                div.classList.add('feed-block');
                div.appendChild(img);
                div.appendChild(p);
                div.appendChild(span);
                let reactions = document.createElement('div');
                reactions.classList.add('reactions');
                reactions.innerHTML = "<span id='like' onclick='handleReactionNotPersisted(this.id)'><i class='far fa-thumbs-up'></i><span class='small feed-reaction-count'>0</span></span><span id='dislike' onclick='handleReactionNotPersisted(this.id)'><i class='far fa-thumbs-down'></i><span class='small feed-reaction-count'>0</span></span><span id='love' onclick='handleReactionNotPersisted(this.id)'><i class='far fa-heart'></i><span class='small feed-reaction-count'>0</span></span>";
                div.append(reactions);
                document.querySelector('.feed').appendChild(div);
            }
        });
      }

      function askNotificationPermission(token) {
        function handlePermission(permission) {
          if(!('permission' in Notification)) {
            Notification.permission = permission;
          }

          if(Notification.permission === 'denied' || Notification.permission === 'default') {
            console.log('Permission was ' + Notification.permission);
          } else {
              getNotifications(token);
            }
        }

        if (!('Notification' in window)) {
          console.log("This browser does not support notifications.");
        } else {
          if(checkNotificationPromise()) {
            Notification.requestPermission()
            .then((permission) => {
              handlePermission(permission);
            })
          } else {
            Notification.requestPermission(function(permission) {
              handlePermission(permission);
            });
          }
        }
      }

      function checkNotificationPromise() {
        try {
          Notification.requestPermission().then();
        } catch(e) {
          return false;
        }

        return true;
      }

      function sendNotification(title, body) {
        let icon = '/logo560-rc.png';
        let notification = new Notification(title, { body: body, icon: icon });
      }

      function getToken() {
        fetch('https://cactuar.moogleapi.com/v1/account/token', {
          method: 'get'
        }).then(response => response.json())
          .then(function(response) {
            localStorage.setItem('token', response.token);
            let token = localStorage.getItem('token');
            if (token) {
              getPenelo(token);
            } else {
              getToken();
            }
          });
      }

      function getAnnouncements(token) {
        fetch('https://cactuar.moogleapi.com/v1/announcement/get', {
          method: 'get',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        }).then(response => response.json())
          .then(function(response) {
            if (response.length > 0) {
              for (i = 0; i < response.length; i++) {
                let img = document.createElement('img');
                let contentImg = document.createElement('img');
                let p = document.createElement('p');
                let span = document.createElement('span');
                let div = document.createElement('div');
                img.src = response[i].image;
                contentImg.src = response[i].contentImage;
                contentImg.style.width = '30%';
                contentImg.style.height = 'auto';
                contentImg.style.borderRadius = '15px';
                p.innerHTML = response[i].content;
                let timestamp = new Date(response[i].timeStamp + 'Z');
                span.innerHTML = timestamp.toLocaleString();
                div.classList.add('feed-block');
                div.appendChild(img);
                div.appendChild(p);
                if (response[i].contentImage) {
                  let contentImgDiv = document.createElement('div');
                  contentImgDiv.style.width = '100%';
                  contentImgDiv.appendChild(contentImg);
                  div.appendChild(contentImgDiv);
                }
                div.appendChild(span);
                let reactions = document.createElement('div');
                reactions.classList.add('reactions');
                reactions.innerHTML = "<span id='like_"+response[i].id+"' onclick='handleReaction(this.id)'><i class='far fa-thumbs-up'></i><span class='small feed-reaction-count'>"+response[i].like+"</span></span><span id='dislike_"+response[i].id+"' onclick='handleReaction(this.id)'><i class='far fa-thumbs-down'></i><span class='small feed-reaction-count'>"+response[i].dislike+"</span></span><span id='love_"+response[i].id+"' onclick='handleReaction(this.id)'><i class='far fa-heart'></i><span class='small feed-reaction-count'>"+response[i].love+"</span></span>";
                div.append(reactions);
                document.querySelector('.feed').appendChild(div);
              }
            }
        });
      }

      function getNotifications(token) {
        fetch('https://cactuar.moogleapi.com/v1/notification/get', {
          method: 'get',
          headers: {
            'Authorization': 'Bearer ' + token
          }
        }).then(response => response.json())
          .then(function(response) {
            if (response.length > 0) {
              console.log("Notifications coming soon!")
              //sendNotification(response[0].title, response[0].body);
            }
        });
      }

      function handleReaction(thisId) {
        let reaction = thisId.split('_')[0];
        let id = thisId.split('_')[1];

        fetch('https://cactuar.moogleapi.com/v1/announcement/'+ reaction +'/' + id, {
        method: 'put'
        }).then(response => response.json())
          .then(function(response) {
          document.getElementById(thisId).getElementsByClassName('feed-reaction-count')[0].innerHTML = response;
        })
      }

      function handleReactionNotPersisted(thisId) {
        debugger
        let prev = +document.getElementById(thisId).getElementsByClassName('feed-reaction-count')[0].innerHTML;
        let next = ++prev;
        document.getElementById(thisId).getElementsByClassName('feed-reaction-count')[0].innerHTML = next;
      }
    </script>
  </body>
</html>
